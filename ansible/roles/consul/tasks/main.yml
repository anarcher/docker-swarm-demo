- name: Pull images
  sudo: True
  command: >
        docker pull {{ item }}:latest
  with_items: docker_images

- name: Run consul
  sudo: yes
  shell: > 
        if ! docker ps -a | grep consul ; then
            docker create --name consul -p 8400:8400 -p 8500:8500 -p 8600:53/udp -h dockerswarm01 progrium/consul -server -bootstrap-expect=1 -ui-dir=/ui ;
        fi

- name: Upstart consul
  template: >
      src=consul.upstart.j2 
      dest=/etc/init/consul.conf
      owner=root
      group=root
      mode=0644
  notify:
      - restart consul
  sudo: yes
  
- name: Start and enable Consul
  sudo: yes
  service: >
      name=consul
      state=started
      enabled=true
